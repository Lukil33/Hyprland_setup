# === GESTORE BATTERIA ROFI ===

# Funzione per ottenere lo stato corrente della batteria
get_charge() {
    battery=$(cat /sys/class/power_supply/BAT*/capacity)

    filled_blocks=$((battery / 10))
    empty_blocks=$((10 - filled_blocks))
    
    bar=""
    for ((i=0; i<filled_blocks; i++)); do
        bar+="#"
    done
    for ((i=0; i<empty_blocks; i++)); do
        bar+="_"
    done

    echo "$battery% [$bar]"
}

get_power_state() {
    # Trova il dispositivo AC corretto
    for supply in /sys/class/power_supply/AC* /sys/class/power_supply/ADP*; do
        if [[ -e "$supply/online" ]]; then
            online=$(cat "$supply/online")
            if [[ "$online" == "1" ]]; then
                echo "-> Charging"
            else
                echo ""
            fi
            return
        fi
    done
    echo "Stato sconosciuto"
}


# Funzione per impostare il governor su tutti i core
set_governor_all_cores() {
    GOV=$1
    for CPUFREQ in /sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_governor; do
        echo "$GOV" | sudo tee "$CPUFREQ" > /dev/null
    done
}

# Loop principale
while true; do
    CURRENT_CHARGE=$(get_charge)
    CURRENT_STATE=$(get_power_state)
    CURRENT_GOVERNOR=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)

    # Menu Rofi
    choice=$(echo -e "Batteria: $CURRENT_CHARGE $CURRENT_STATE\nGovernor attuale: $CURRENT_GOVERNOR\n--------------------\nGovernor: Performance\nGovernor: Powersave\n--------------------\nExit"| rofi -dmenu -i -p "Gestione Energia")
    
    case "$choice" in
        "Governor: Performance")
            set_governor_all_cores "performance"
            ;;
        "Governor: Powersave")
            set_governor_all_cores "powersave"
            ;;
        *)
            exit 0
            ;;
    esac
done