#!/usr/bin/env bash

# Esegui una scansione Wi-Fi aggiornata
nmcli device wifi rescan &>/dev/null
sleep 1

# Ottieni SSID attualmente connesso
current_ssid=$(nmcli -t -f active,ssid dev wifi | awk -F: '$1 == "yes" {print $2; exit}')

# Ottieni lista reti: SSID, segnale, sicurezza. tenendo conto di non mostrare duplicati
networks_raw=$(nmcli -t -f SSID,SIGNAL,SECURITY device wifi list | grep -v '^:' | awk -F: '
{
    if ($1 != "" && (!($1 in seen) || $2 > seen[$1])) {
        ssid = $1
        seen[ssid] = $2
        data[ssid] = $0
    }
}
END {
    for (s in data) print data[s]
}')


# Crea lista formattata con icone
networks=$(echo "$networks_raw" | awk -F: -v current="$current_ssid" '
function network_icon(signal){
    if (signal >= 80) return "󰣺";
    else if (signal >= 60) return "󰣸";
    else if (signal >= 40) return "󰣶";
    else if (signal >= 20) return "󰣴";
    else return "󰣾";
}
{
    ssid = $1;
    signal = $2;
    if (ssid != "") {
        icon = network_icon(signal);
        label = (ssid == current) ? "-> " ssid : ssid;
        printf "%03d %s %s\n", signal, icon, label;
    }
}' | sort -nr | cut -d' ' -f2-)

# Mostra la lista con rofi
choice=$(echo -e "$networks\n--------------------\nReload\nBack\nExit" | rofi -dmenu -i -p "Selezione rete")

# Gestione scelta
case "$choice" in
    "Reload")
        notify-send "Wi-Fi" "Scansione in corso..."
        exec "$HOME/.config/rofi/Network/rofi-show-network"
        ;;
    "Back")
        exec "$HOME/.config/rofi/Network/rofi-network"
        ;;
    "--------------------")
        exit 0
        ;;
    "Exit")
        exit 0
        ;;
    *)
        # Estrai SSID dalla riga selezionata (rimuovi icona + eventuale "-> ")
        ssid=$(echo "$choice" | sed -E 's/^[^ ]+ //' | sed -E 's/^-> //')
    
        # Ottieni il tipo di sicurezza per la rete selezionata
        security=$(echo "$networks_raw" | awk -F: -v ssid="$ssid" '$1 == ssid {print ($3 == "" ? "--" : $3); exit}')
       
        previous_ssid="$current_ssid"

        connect_with_saved() {
            nmcli connection up "$ssid" &>/dev/null
        }

        connect_with_password() {
            password=$(rofi -dmenu -p "Password per $ssid:" -password)
            [[ -z "$password" ]] && return 1
            nmcli device wifi connect "$ssid" password "$password" &>/dev/null
        }

        # Prova connessione salvata
        if connect_with_saved; then
            # Se la connessione ha successo -> torna allo script principale
            exec "$HOME/.config/rofi/Network/rofi-network" -config ~/.config/rofi/config.rasi
        else
            # Se la connessione fallisce -> elimina connessione salvata
            nmcli connection delete "$ssid" &>/dev/null
        fi

        # Se la connessione salvata fallisce -> chiedi password se necessaria
        if [[ "$security" == "--" ]]; then
            # Rete aperta, nessuna password necessaria
            if nmcli device wifi connect "$ssid" &>/dev/null; then
                exec "$HOME/.config/rofi/Network/rofi-network"
            else
                notify-send "Connessione fallita" "Impossibile connettersi a \"$ssid\""
                [[ -n "$previous_ssid" ]] && nmcli connection up "$previous_ssid" &>/dev/null
                exec "$HOME/.config/rofi/Network/rofi-network"
            fi
        else
            # Se la rete è protetta -> chiedi password
            if connect_with_password; then
                # Connessione riuscita
                exec "$HOME/.config/rofi/Network/rofi-network"
            else
                # Se la password è errata -> rimuovi eventuale connessione creata
                nmcli connection delete "$ssid" &>/dev/null
                notify-send "Connessione fallita" "Password errata per \"$ssid\""
                [[ -n "$previous_ssid" ]] && nmcli connection up "$previous_ssid" &>/dev/null
                exec "$HOME/.config/rofi/Network/rofi-network"
            fi
        fi
        ;;
esac