#!/usr/bin/env bash

TERMINAL="kitty"  # Cambia con foot, alacritty, wezterm, ecc.
CACHE_FILE="/tmp/.wifi_rofi_cache"

# Ottieni stato del Wi-Fi e rete attiva
wifi_enabled=$(nmcli radio wifi)
current_connection=$(nmcli -t -f NAME,DEVICE connection show --active | grep ":w" | cut -d: -f1)
wifi_status=$( [ -n "$current_connection" ] && echo "Connected -> $current_connection" || echo "Disconnected" )

# Se cache non esiste, crea una lista di reti SENZA rescan (evita lentezza)
if [[ ! -f "$CACHE_FILE" ]]; then
    nmcli -t -f SSID,SIGNAL device wifi list > "$CACHE_FILE"
fi

# Funzione per leggere e formattare la lista di reti Wi-Fi dalla cache
get_networks() {
    local connected_ssid="$current_connection"
    cat "$CACHE_FILE" |
    grep -v "^:" |
    awk -F: '$1 != "" {printf "%s\t%s\n", $1, $2}' |
    sort -k2 -nr |
    awk -v conn="$connected_ssid" -F'\t' '!seen[$1]++ {
        if ($1 == conn)
            printf "* %s (%s%%)\n", $1, $2;
        else
            printf "%s (%s%%)\n", $1, $2;
    }'
}

# Ottieni reti dalla cache
networks="$(get_networks)"

# Mostra menu con rofi
choice=$(echo -e "Available networks:\n$networks\n---------\nOpen Network Manager\nScansiona reti\nWi-Fi: $wifi_enabled\nStatus: $wifi_status\nExit\n" | rofi -dmenu -i -p "Gestione Wi-Fi")

# Gestione scelta
case "$choice" in
    "Open Network Manager")
        $TERMINAL -e nmtui
        ;;
    "Wi-Fi: on")
        nmcli radio wifi off
        ;;
    "Wi-Fi: off")
        nmcli radio wifi on
        ;;
    "Status: "*)
        notify-send "Stato Wi-Fi" "$wifi_status"
        ;;
    "Scansiona reti")
        notify-send "Wi-Fi" "Scansione in corso..."
        nmcli device wifi rescan
        sleep 2
        nmcli -t -f SSID,SIGNAL device wifi list > "$CACHE_FILE"
        exec "$0"
        ;;
    *)
        # Se contiene una percentuale tra parentesi, è una rete
        if [[ "$choice" =~ \([0-9]+%\)$ ]]; then
            ssid=$(echo "$choice" | cut -d '(' -f1 | sed 's/[*•] //;s/ *$//')
            if nmcli connection show | grep -qw "$ssid"; then
                nmcli connection up "$ssid"
            else
                password=$(rofi -dmenu -p "Password per $ssid:" -password)
                [ -z "$password" ] && exit
                nmcli device wifi connect "$ssid" password "$password"
            fi
        else
            exit 0
        fi
        ;;
esac
